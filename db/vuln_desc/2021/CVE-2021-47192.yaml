descriptions:
- lang: en
  value: 'In the Linux kernel, the following vulnerability has been resolved:


    scsi: core: sysfs: Fix hang when device state is set via sysfs


    This fixes a regression added with:


    commit f0f82e2476f6 ("scsi: core: Fix capacity set to zero after

    offlinining device")


    The problem is that after iSCSI recovery, iscsid will call into the kernel

    to set the dev''s state to running, and with that patch we now call

    scsi_rescan_device() with the state_mutex held. If the SCSI error handler

    thread is just starting to test the device in scsi_send_eh_cmnd() then it''s

    going to try to grab the state_mutex.


    We are then stuck, because when scsi_rescan_device() tries to send its I/O

    scsi_queue_rq() calls -> scsi_host_queue_ready() -> scsi_host_in_recovery()

    which will return true (the host state is still in recovery) and I/O will

    just be requeued. scsi_send_eh_cmnd() will then never be able to grab the

    state_mutex to finish error handling.


    To prevent the deadlock move the rescan-related code to after we drop the

    state_mutex.


    This also adds a check for if we are already in the running state. This

    prevents extra scans and helps the iscsid case where if the transport class

    has already onlined the device during its recovery process then we don''t

    need userspace to do it again plus possibly block that daemon.'
id: CVE-2021-47192
lastModified: '2024-04-10T19:49:51.183'
metrics: {}
published: '2024-04-10T19:15:47.710'
references:
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/4edd8cd4e86dd3047e5294bbefcc0a08f66a430f
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/a792e0128d232251edb5fdf42fb0f9fbb0b44a73
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/bcc0e3175a976b7fa9a353960808adb0bb49ead8
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/edd783162bf2385b43de6764f2d4c6e9f4f6be27
sourceIdentifier: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
vulnStatus: Awaiting Analysis
