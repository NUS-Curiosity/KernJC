cveTags: []
descriptions:
- lang: en
  value: 'In the Linux kernel, the following vulnerability has been resolved:


    ARM: 9381/1: kasan: clear stale stack poison


    We found below OOB crash:


    [   33.452494] ==================================================================

    [   33.453513] BUG: KASAN: stack-out-of-bounds in refresh_cpu_vm_stats.constprop.0+0xcc/0x2ec

    [   33.454660] Write of size 164 at addr c1d03d30 by task swapper/0/0

    [   33.455515]

    [   33.455767] CPU: 0 PID: 0 Comm: swapper/0 Tainted: G           O       6.1.25-mainline
    #1

    [   33.456880] Hardware name: Generic DT based system

    [   33.457555]  unwind_backtrace from show_stack+0x18/0x1c

    [   33.458326]  show_stack from dump_stack_lvl+0x40/0x4c

    [   33.459072]  dump_stack_lvl from print_report+0x158/0x4a4

    [   33.459863]  print_report from kasan_report+0x9c/0x148

    [   33.460616]  kasan_report from kasan_check_range+0x94/0x1a0

    [   33.461424]  kasan_check_range from memset+0x20/0x3c

    [   33.462157]  memset from refresh_cpu_vm_stats.constprop.0+0xcc/0x2ec

    [   33.463064]  refresh_cpu_vm_stats.constprop.0 from tick_nohz_idle_stop_tick+0x180/0x53c

    [   33.464181]  tick_nohz_idle_stop_tick from do_idle+0x264/0x354

    [   33.465029]  do_idle from cpu_startup_entry+0x20/0x24

    [   33.465769]  cpu_startup_entry from rest_init+0xf0/0xf4

    [   33.466528]  rest_init from arch_post_acpi_subsys_init+0x0/0x18

    [   33.467397]

    [   33.467644] The buggy address belongs to stack of task swapper/0/0

    [   33.468493]  and is located at offset 112 in frame:

    [   33.469172]  refresh_cpu_vm_stats.constprop.0+0x0/0x2ec

    [   33.469917]

    [   33.470165] This frame has 2 objects:

    [   33.470696]  [32, 76) ''global_zone_diff''

    [   33.470729]  [112, 276) ''global_node_diff''

    [   33.471294]

    [   33.472095] The buggy address belongs to the physical page:

    [   33.472862] page:3cd72da8 refcount:1 mapcount:0 mapping:00000000 index:0x0
    pfn:0x41d03

    [   33.473944] flags: 0x1000(reserved|zone=0)

    [   33.474565] raw: 00001000 ed741470 ed741470 00000000 00000000 00000000 ffffffff
    00000001

    [   33.475656] raw: 00000000

    [   33.476050] page dumped because: kasan: bad access detected

    [   33.476816]

    [   33.477061] Memory state around the buggy address:

    [   33.477732]  c1d03c00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00

    [   33.478630]  c1d03c80: 00 00 00 00 00 00 00 00 f1 f1 f1 f1 00 00 00 00

    [   33.479526] >c1d03d00: 00 04 f2 f2 f2 f2 00 00 00 00 00 00 f1 f1 f1 f1

    [   33.480415]                                                ^

    [   33.481195]  c1d03d80: 00 00 00 00 00 00 00 00 00 00 04 f3 f3 f3 f3 f3

    [   33.482088]  c1d03e00: f3 f3 f3 f3 00 00 00 00 00 00 00 00 00 00 00 00

    [   33.482978] ==================================================================


    We find the root cause of this OOB is that arm does not clear stale stack

    poison in the case of cpuidle.


    This patch refer to arch/arm64/kernel/sleep.S to resolve this issue.


    From cited commit [1] that explain the problem


    Functions which the compiler has instrumented for KASAN place poison on

    the stack shadow upon entry and remove this poison prior to returning.


    In the case of cpuidle, CPUs exit the kernel a number of levels deep in

    C code.  Any instrumented functions on this critical path will leave

    portions of the stack shadow poisoned.


    If CPUs lose context and return to the kernel via a cold path, we

    restore a prior context saved in __cpu_suspend_enter are forgotten, and

    we never remove the poison they placed in the stack shadow area by

    functions calls between this and the actual exit of the kernel.


    Thus, (depending on stackframe layout) subsequent calls to instrumented

    functions may hit this stale poison, resulting in (spurious) KASAN

    splats to the console.


    To avoid this, clear any stale poison from the idle thread for a CPU

    prior to bringing a CPU online.


    From cited commit [2]


    Extend to check for CONFIG_KASAN_STACK


    [1] commit 0d97e6d8024c ("arm64: kasan: clear stale stack poison")

    [2] commit d56a9ef84bd0 ("kasan, arm64: unpoison stack only with CONFIG_KASAN_STACK")'
- lang: es
  value: "En el kernel de Linux, se ha resuelto la siguiente vulnerabilidad: ARM:\
    \ 9381/1: kasan: borrar veneno de pila obsoleta Encontramos el siguiente fallo\
    \ de OOB: [33.452494] ================== ===================================================\
    \ [ 33.453513] ERROR: KASAN: pila fuera de los l\xEDmites en refresco_cpu_vm_stats.constprop.0+0xcc/0x2ec\
    \ [33.454660] Escritura de tama\xF1o 164 en la direcci\xF3n c1d03d30 mediante\
    \ task swapper/0/0 [33.455515] [33.455767] CPU: 0 PID : 0 Comm: swapper/0 Tainted:\
    \ GO 6.1.25-mainline #1 [ 33.456880] Nombre del hardware: Sistema basado en DT\
    \ gen\xE9rico [ 33.457555] unwind_backtrace from show_stack+0x18/0x1c [ 33.458326]\
    \ show_stack from dump_stack_lvl+0x40/0x4c [ 33.45 9072] dump_stack_lvl de print_report+0x158/0x4a4\
    \ [ 33.459863] print_report de kasan_report+0x9c/0x148 [ 33.460616] kasan_report\
    \ de kasan_check_range+0x94/0x1a0 [ 33.461424] kasan_check_range de memset+0x20/0x\
    \ 3c [33.462157] conjunto de memorias de refresco_cpu_vm_stats.constprop.0+0xcc/\
    \ 0x2ec [33.463064] refresco_cpu_vm_stats.constprop.0 de tick_nohz_idle_stop_tick+0x180/0x53c\
    \ [33.464181] tick_nohz_idle_stop_tick de do_idle+0x264/0x354 [33.465029] do_idle\
    \ de cpu_startup _entry+0x20/0x24 [ 33.465769] cpu_startup_entry de rest_init+0xf0/0xf4\
    \ [ 33.466528] rest_init de arch_post_acpi_subsys_init+0x0/0x18 [33.467397] [33.467644]\
    \ La direcci\xF3n con errores pertenece a la pila de task swapper/0/0 [33.468493]\
    \ y se encuentra en el desplazamiento 112 en el framework: [33.469172] [ 33.469917\
    \ ] [ 33.470165] Este framework tiene 2 objetos: [ 33.470696] [32, 76) 'global_zone_diff'\
    \ [ 33.470729] [112, 276) 'global_node_diff' [ 33.471294] [ 33.472095] La direcci\xF3\
    n con errores pertenece a la p\xE1gina f\xEDsica: [ 33.47 2862] p\xE1gina:3cd72da8\
    \ refcount:1 mapcount:0 mapeo:00000000 \xEDndice:0x0 pfn:0x41d03 [ 33.473944]\
    \ banderas: 0x1000(reservado|zona=0) [ 33.474565] raw: 00001000 ed741470 ed741470\
    \ 00000000 000000 00000000 ffffffff 00000001 [ 33.475656] sin formato: 00000000\
    \ [33.476050] p\xE1gina volcada porque: kasan: mal acceso detectado [33.476816]\
    \ [33.477061] Estado de la memoria alrededor de la direcci\xF3n con errores: [33.477732]\
    \ c1d03c00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 0 [33.478630] c1d03c80\
    \ : 00 00 00 00 00 00 00 00 f1 f1 f1 f1 00 00 00 00 [ 33.479526] &gt;c1d03d00:\
    \ 00 04 f2 f2 f2 f2 00 00 00 00 00 00 f1 f1 f1 f1 [ 33.480415] ^ [ 3.481195] c1d03d80:\
    \ 00 00 00 00 00 00 00 00 00 00 04 f3 f3 f3 f3 f3 [ 33.482088] c1d03e00: f3 f3\
    \ f3 f3 00 00 00 00 00 00 00 00 00 00 00 00 [ 33.482978] === ====================================================\
    \ ==== Descubrimos que la causa principal de este OOB es que el brazo no elimina\
    \ el veneno de la pila obsoleta en el caso de cpuidle. Este parche hace referencia\
    \ a arch/arm64/kernel/sleep.S para resolver este problema. Del compromiso citado\
    \ [1] que explica el problema. Las funciones que el compilador ha instrumentado\
    \ para KASAN colocan veneno en la sombra de la pila al ingresar y eliminan este\
    \ veneno antes de regresar. En el caso de cpuidle, las CPU salen del kernel a\
    \ varios niveles de profundidad en el c\xF3digo C. Cualquier funci\xF3n instrumentada\
    \ en esta ruta cr\xEDtica dejar\xE1 partes de la sombra de la pila envenenadas.\
    \ Si las CPU pierden contexto y regresan al kernel a trav\xE9s de una ruta fr\xED\
    a, restauramos un contexto anterior guardado en __cpu_suspend_enter que se olvida\
    \ y nunca eliminamos el veneno que colocaron en el \xE1rea de sombra de la pila\
    \ mediante llamadas a funciones entre este y la salida real del kernel. . Por\
    \ lo tanto, (dependiendo del dise\xF1o del framework de pila) las llamadas posteriores\
    \ a funciones instrumentadas pueden afectar este veneno obsoleto, lo que resulta\
    \ en s\xEDmbolos KASAN (falsos) en la consola. Para evitar esto, elimine cualquier\
    \ veneno obsoleto del subproceso inactivo de una CPU antes de ponerla en l\xED\
    nea. De la confirmaci\xF3n citada [2] Ampliar para verificar CONFIG_KASAN_STACK\
    \ [1] commit 0d97e6d8024c (\"arm64: kasan: borrar veneno de pila obsoleta\") [2]\
    \ commit d56a9ef84bd0 (\"kasan, arm64: pila sin veneno solo con CONFIG_KASAN_STACK\"\
    )"
id: CVE-2024-36906
lastModified: '2024-05-30T18:18:58.870'
metrics: {}
published: '2024-05-30T16:15:14.130'
references:
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/20ac71bee028ffbae4fc14ed679b23b4d3e95726
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/ad702338fe423cb1e79745787090317256a98dab
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/b26f353786d365e658cebc9a9ace88e04fc2325e
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/c4238686f9093b98bd6245a348bcf059cdce23af
- source: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
  url: https://git.kernel.org/stable/c/ee0ce7573e5083031960faf602c9db693ab5b477
sourceIdentifier: 416baaa9-dc9f-4396-8d5f-8c081fb06d67
vulnStatus: Awaiting Analysis
